<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faz Drifting BFD</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.min.js"></script>
<style>
body{margin:0;overflow:hidden;font-family:Arial,sans-serif;background:#000;}
canvas{display:block;}

/* Start/Login Screen */
#loginScreen{
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:#000 url('/mnt/data/A_digital_illustration_in_GTA_V-style_features_a_s.png') center center / cover no-repeat;
  display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;
  font-size:28px;text-align:center;z-index:20;text-shadow:0 0 15px black;
}
#loginScreen input{
  font-size:20px;padding:10px;margin:5px;border-radius:10px;border:none;
}
#loginScreen button{
  font-size:20px;padding:10px 20px;margin-top:10px;border-radius:10px;border:none;
  cursor:pointer;background:#ff4444;color:white;
}

/* HUD */
#hud{
  position:absolute;top:20px;left:20px;color:white;background:rgba(0,0,0,0.7);
  padding:20px;border-radius:15px;z-index:10;font-size:18px;box-shadow:0 0 20px rgba(255,68,68,0.5);
}
#instructions{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.8);padding:20px;border-radius:15px;color:#fff;
  text-align:center;z-index:10;max-width:90%;font-size:16px;
}
</style>
</head>
<body>

<div id="loginScreen">
  <div id="loginTitle">FAZ DRIFTING BFD</div>
  <input type="text" id="username" placeholder="Username"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="registerBtn">Register</button>
  <button id="loginBtn">Login</button>
  <div id="loginMsg" style="margin-top:10px;color:yellow;"></div>
</div>

<div id="hud">
Speed: <span id="speed">0</span> km/h | Drift: <span id="points">0</span> | Money: $<span id="money">0</span> | Mission: <span id="mission">None</span>
</div>

<div id="instructions">
WASD = Accelerate/Brake/Steer | SPACE = Drift | Collect coins, complete missions!
</div>

<script>
// =======================
// Account System
// =======================
let username="";
let driftPoints=0;
let money=0;
let upgrades={speed:1,handling:1,drift:1};
let mission={active:false,pos:null,reward:0};

function saveAccount(user){
  localStorage.setItem('fd_account_'+user,JSON.stringify({password:loadAccount(user).password,driftPoints,money,upgrades,mission}));
}
function loadAccount(user){
  const data=localStorage.getItem('fd_account_'+user);
  return data?JSON.parse(data):null;
}
function hash(str){let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0;}return h;}

document.getElementById('registerBtn').addEventListener('click',()=>{
  const user=document.getElementById('username').value.trim();
  const pass=document.getElementById('password').value;
  if(!user||!pass){document.getElementById('loginMsg').innerText="Enter username & password";return;}
  if(loadAccount(user)){document.getElementById('loginMsg').innerText="Username exists";return;}
  localStorage.setItem('fd_account_'+user,JSON.stringify({password:hash(pass),driftPoints:0,money:0,upgrades:{speed:1,handling:1,drift:1},mission:{active:false,pos:null,reward:0}}));
  document.getElementById('loginMsg').innerText="Registered! You can login now.";
});

document.getElementById('loginBtn').addEventListener('click',()=>{
  const user=document.getElementById('username').value.trim();
  const pass=document.getElementById('password').value;
  const acc=loadAccount(user);
  if(!acc){document.getElementById('loginMsg').innerText="Account not found";return;}
  if(acc.password!==hash(pass)){document.getElementById('loginMsg').innerText="Wrong password";return;}
  username=user; driftPoints=acc.driftPoints; money=acc.money; upgrades=acc.upgrades; mission=acc.mission;
  startGame();
});

setInterval(()=>{if(username) saveAccount(username);},5000);

// =======================
// Three.js Setup
// =======================
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
scene.fog=new THREE.FogExp2(0x87ceeb,0.00025);
const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,5000);
camera.position.set(0,15,30);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

// Lights
const ambient=new THREE.AmbientLight(0x404040,0.6);
scene.add(ambient);
const dirLight=new THREE.DirectionalLight(0xffffff,1.2);
dirLight.position.set(50,100,50); dirLight.castShadow=true; scene.add(dirLight);

// Ground
const groundGeo=new THREE.PlaneGeometry(1000,1000);
const groundMat=new THREE.MeshLambertMaterial({color:0x222222});
const ground=new THREE.Mesh(groundGeo,groundMat);
ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);

// Small City Buildings
const buildings=[];
for(let i=0;i<12;i++){
  const w=20+Math.random()*30,h=20+Math.random()*60,d=20+Math.random()*30;
  const geo=new THREE.BoxGeometry(w,h,d);
  const mat=new THREE.MeshLambertMaterial({color:0x888888*Math.random()});
  const b=new THREE.Mesh(geo,mat);
  b.position.set((Math.random()-0.5)*400, h/2, (Math.random()-0.5)*400);
  b.castShadow=true; b.receiveShadow=true;
  scene.add(b); buildings.push(b);
}

// Player Car
const carGroup=new THREE.Group();
const bodyGeo=new THREE.BoxGeometry(2.2,1.1,4.4);
const bodyMat=new THREE.MeshLambertMaterial({color:0xff3333});
const body=new THREE.Mesh(bodyGeo,bodyMat); body.castShadow=true; carGroup.add(body);

// Wheels
const wheelGeo=new THREE.CylinderGeometry(0.45,0.45,0.35,12);
const wheelMat=new THREE.MeshLambertMaterial({color:0x111111});
const playerWheels=[];
for(let i=0;i<4;i++){
  const wheel=new THREE.Mesh(wheelGeo,wheelMat);
  wheel.rotation.z=Math.PI/2; wheel.castShadow=true; playerWheels.push(wheel); carGroup.add(wheel);
}
playerWheels[0].position.set(-1.2,-0.55,1.6); playerWheels[1].position.set(1.2,-0.55,1.6);
playerWheels[2].position.set(-1.2,-0.55,-1.6); playerWheels[3].position.set(1.2,-0.55,-1.6);

scene.add(carGroup); carGroup.position.set(0,0.5,0);

// Loot coins
const coins=[];
for(let i=0;i<20;i++){
  const geo=new THREE.SphereGeometry(0.5,8,6);
  const mat=new THREE.MeshStandardMaterial({color:0xffcc00});
  const coin=new THREE.Mesh(geo,mat);
  coin.position.set((Math.random()-0.5)*400,0.5,(Math.random()-0.5)*400);
  scene.add(coin); coins.push(coin);
}

// =======================
// Player Input
// =======================
const velocity=new THREE.Vector3();
let moveForward=false,moveBackward=false,moveLeft=false,moveRight=false,handbrake=false;
document.addEventListener('keydown',e=>{
  switch(e.code){case 'KeyW': moveForward=true;break;case 'KeyS': moveBackward=true;break;
  case 'KeyA': moveLeft=true;break;case 'KeyD': moveRight=true;break;case 'Space': handbrake=true;break;}
});
document.addEventListener('keyup',e=>{
  switch(e.code){case 'KeyW': moveForward=false;break;case 'KeyS': moveBackward=false;break;
  case 'KeyA': moveLeft=false;break;case 'KeyD': moveRight=false;break;case 'Space': handbrake=false;break;}
});

// =======================
// Start Game
// =======================
function startGame(){
  document.getElementById('loginScreen').style.display='none';
  animate();
}

// =======================
// Animate Loop
// =======================
function animate(){
  requestAnimationFrame(animate);

  // Player movement
  let accel=0;
  if(moveForward) accel+=0.1*upgrades.speed; if(moveBackward) accel-=0.06;
  velocity.z+=accel; velocity.z*=(handbrake?0.85:0.95);
  const maxSpeed=2.2*upgrades.speed; velocity.z=Math.max(-maxSpeed*0.7,Math.min(velocity.z,maxSpeed));

  let steer=0; if(moveLeft) steer-=1; if(moveRight) steer+=1;
  carGroup.rotation.y+=steer*0.05*upgrades.handling;

  carGroup.position.x+=Math.sin(carGroup.rotation.y)*velocity.z;
  carGroup.position.z+=Math.cos(carGroup.rotation.y)*velocity.z;

  // Rotate wheels
  const wheelSpeed=velocity.z*4; playerWheels.forEach(w=>{w.rotation.x+=wheelSpeed;});

  // Loot collection
  for(let i=coins.length-1;i>=0;i--){
    const coin=coins[i];
    if(coin.position.distanceTo(carGroup.position)<2){
      money+=10; scene.remove(coin); coins.splice(i,1);
    }
  }

  // HUD
  document.getElementById('speed').textContent=Math.floor(Math.abs(velocity.z)*45);
  document.getElementById('points').textContent=Math.floor(driftPoints);
  document.getElementById('money').textContent=Math.floor(money);
  document.getElementById('mission').textContent=mission.active?"Drive to checkpoint":"None";

  // Camera
  const camOffset=new THREE.Vector3(0,10,20);
  camOffset.applyQuaternion(carGroup.quaternion); camOffset.add(carGroup.position);
  camera.position.lerp(camOffset,0.1);
  camera.lookAt(carGroup.position.clone().add(new THREE.Vector3(0,2,5)));

  renderer.render(scene,camera);
}

// Resize
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
