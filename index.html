<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faz Drifting BFD</title>
    <style>
        body { margin: 0; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif; color: #fff; }
        canvas { background: #333; border: 3px solid #444; box-shadow: 0 0 30px rgba(0,0,0,0.9); cursor: none; }
        h1 { color: #ff4444; margin: 0 0 10px 0; text-shadow: 0 0 10px #ff0000; }
        p { color: #ccc; margin: 0; text-align: center; max-width: 800px; }
    </style>
</head>
<body>
    <h1>Faz Drifting BFD</h1>
    <p>ARROW KEYS to drive | DRIFT by sharp turns at speed! | Missions: 1 or 2 | R=Reset | ESC/M=Menu</p>
    <canvas id="canvas" width="800" height="600" tabindex="1"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        canvas.focus();

        // Car
        const car = {
            x: 400,
            y: 300,
            width: 28,
            height: 48,
            angle: 0,
            velocityX: 0,
            velocityY: 0,
            velMag: 0,
            accelForce: 0.28,
            drag: 0.965,
            turnSpeed: 0.035
        };

        // Input
        const keys = {};
        const pressed = {};
        window.addEventListener('keydown', e => {
            if (!keys[e.key]) {
                pressed[e.key] = true;
            }
            keys[e.key] = true;
            e.preventDefault();
        });
        window.addEventListener('keyup', e => {
            keys[e.key] = false;
            pressed[e.key] = false;
            e.preventDefault();
        });

        // Game state
        let gameState = 'menu'; // menu, playing, success
        let currentMission = 0;
        let startTime = 0;
        let particles = [];

        const missions = [
            {
                name: 'Drift King',
                type: 'drift',
                target: 3000,
                current: 0
            },
            {
                name: 'Checkpoint Dash',
                type: 'checkpoints',
                target: 6,
                current: 0,
                checkpoints: [],
                currentCp: 0
            }
        ];

        function resetMission() {
            car.x = 400;
            car.y = 300;
            car.angle = 0;
            car.velocityX = 0;
            car.velocityY = 0;
            car.velMag = 0;
            const m = missions[currentMission];
            m.current = 0;
            particles.length = 0;
            startTime = Date.now();
            if (m.type === 'checkpoints') {
                m.checkpoints = [];
                for (let i = 0; i < 6; i++) {
                    const ang = (i / 6) * Math.PI * 2 + Math.PI / 4;
                    m.checkpoints.push({
                        x: 400 + Math.cos(ang) * 240 + (Math.random() - 0.5) * 120,
                        y: 300 + Math.sin(ang) * 190 + (Math.random() - 0.5) * 90,
                        r: 30,
                        hit: false
                    });
                }
                m.currentCp = 0;
            }
        }

        function update() {
            // Update particles
            particles.forEach(p => {
                p.vx *= 0.96;
                p.vy *= 0.96;
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
            });
            particles = particles.filter(p => p.life > 0);

            // Menu input
            if (gameState === 'menu') {
                if (pressed['1']) {
                    pressed['1'] = false;
                    currentMission = 0;
                    gameState = 'playing';
                    resetMission();
                }
                if (pressed['2']) {
                    pressed['2'] = false;
                    currentMission = 1;
                    gameState = 'playing';
                    resetMission();
                }
                return;
            }

            // Success input
            if (gameState === 'success') {
                if (pressed['r'] || pressed['R']) {
                    pressed['r'] = pressed['R'] = false;
                    resetMission();
                    gameState = 'playing';
                }
                if (pressed['Escape'] || pressed['m'] || pressed['M']) {
                    pressed['Escape'] = pressed['m'] = pressed['M'] = false;
                    gameState = 'menu';
                }
                return;
            }

            // Playing update
            if (gameState !== 'playing') return;

            // Controls
            if (keys['ArrowUp']) {
                car.velocityX += Math.sin(car.angle) * car.accelForce;
                car.velocityY -= Math.cos(car.angle) * car.accelForce;
            } else if (keys['ArrowDown']) {
                car.velocityX += Math.sin(car.angle + Math.PI) * car.accelForce * 0.7;
                car.velocityY -= Math.cos(car.angle + Math.PI) * car.accelForce * 0.7;
            }

            // Drag
            car.velocityX *= car.drag;
            car.velocityY *= car.drag;

            // Steering
            car.velMag = Math.hypot(car.velocityX, car.velocityY);
            if (car.velMag > 0.8) {
                const turnRate = car.turnSpeed * Math.min(car.velMag / 4, 1.8);
                if (keys['ArrowLeft']) car.angle -= turnRate;
                if (keys['ArrowRight']) car.angle += turnRate;
            }

            // Position update
            car.x += car.velocityX;
            car.y += car.velocityY;

            // Boundaries
            if (car.x < 20) { car.x = 20; car.velocityX *= -0.5; }
            if (car.x > 780) { car.x = 780; car.velocityX *= -0.5; }
            if (car.y < 30) { car.y = 30; car.velocityY *= -0.5; }
            if (car.y > 570) { car.y = 570; car.velocityY *= -0.5; }

            // Mission logic
            const m = missions[currentMission];
            if (m.type === 'drift') {
                if (car.velMag > 2.5) {
                    const velAngle = Math.atan2(car.velocityY, car.velocityX);
                    let driftAngle = Math.abs(velAngle - car.angle);
                    if (driftAngle > Math.PI) driftAngle = 2 * Math.PI - driftAngle;
                    if (driftAngle > 0.3) {
                        const scoreAdd = (driftAngle ** 1.5) * car.velMag * 0.18;
                        m.current += scoreAdd;
                        // Emit smoke
                        const smokeCount = Math.floor(driftAngle * 2) + 1;
                        for (let s = 0; s < smokeCount; s++) {
                            const smokeAng = velAngle + Math.PI + (Math.random() - 0.5) * 0.6;
                            const px = car.x + Math.sin(smokeAng) * (18 + Math.random() * 12);
                            const py = car.y - Math.cos(smokeAng) * (18 + Math.random() * 12);
                            particles.push({
                                x: px,
                                y: py,
                                vx: Math.sin(smokeAng) * 0.4 + (Math.random() - 0.5) * 1.8,
                                vy: -Math.cos(smokeAng) * 0.4 + (Math.random() - 0.5) * 1.8,
                                life: 30 + Math.random() * 30,
                                maxLife: 30 + Math.random() * 30,
                                size: 3 + Math.random() * 4
                            });
                        }
                    }
                }
                if (m.current >= m.target) {
                    gameState = 'success';
                }
            } else if (m.type === 'checkpoints') {
                const cp = m.checkpoints[m.currentCp];
                if (Math.hypot(car.x - cp.x, car.y - cp.y) < cp.r) {
                    m.current++;
                    m.currentCp++;
                    cp.hit = true;
                    if (m.currentCp >= m.checkpoints.length) {
                        gameState = 'success';
                    }
                }
            }

            // Global keys
            if (pressed['r'] || pressed['R']) {
                pressed['r'] = pressed['R'] = false;
                resetMission();
            }
            if (pressed['Escape'] || pressed['m'] || pressed['M']) {
                pressed['Escape'] = pressed['m'] = pressed['M'] = false;
                gameState = 'menu';
            }
        }

        function draw() {
            // Road
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, 800, 600);

            // Road lines (animated)
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.setLineDash([30, 30]);
            ctx.lineDashOffset = -(Date.now() / 80) % 60;
            ctx.beginPath();
            ctx.moveTo(400, 0);
            ctx.lineTo(400, 600);
            ctx.moveTo(0, 300);
            ctx.lineTo(800, 300);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.lineDashOffset = 0;

            // Checkpoints
            if (gameState === 'playing' && missions[currentMission].type === 'checkpoints') {
                const m = missions[currentMission];
                m.checkpoints.forEach((cp, i) => {
                    ctx.save();
                    if (i === m.currentCp) {
                        ctx.fillStyle = `rgba(0, 255, 0, ${0.8 + 0.2 * Math.sin(Date.now() / 150)})`;
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 4;
                    } else if (cp.hit) {
                        ctx.fillStyle = '#555';
                    } else {
                        ctx.fillStyle = '#fff';
                    }
                    ctx.beginPath();
                    ctx.arc(cp.x, cp.y, cp.r, 0, Math.PI * 2);
                    ctx.fill();
                    if (i === m.currentCp) {
                        ctx.stroke();
                    }
                    ctx.restore();
                });
            }

            // Particles (smoke)
            particles.forEach(p => {
                ctx.save();
                const alpha = p.life / p.maxLife;
                ctx.globalAlpha = alpha * alpha;
                ctx.fillStyle = '#888';
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size * alpha, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });

            // Car
            ctx.save();
            ctx.translate(car.x, car.y);
            ctx.rotate(car.angle);
            ctx.fillStyle = '#ff4444';
            ctx.shadowColor = '#ff2222';
            ctx.shadowBlur = 15;
            ctx.fillRect(-car.width / 2, -car.height / 2, car.width, car.height);
            ctx.shadowBlur = 0;
            // Details
            ctx.fillStyle = '#333';
            ctx.fillRect(-11, -22, 22, 14); // front
            ctx.fillRect(-11, 6, 22, 14); // rear
            // Wheels
            ctx.fillStyle = '#111';
            ctx.fillRect(-13, -25, 7, 10);
            ctx.fillRect(6, -25, 7, 10);
            ctx.fillRect(-13, 15, 7, 10);
            ctx.fillRect(6, 15, 7, 10);
            ctx.restore();

            // UI
            if (gameState === 'menu') {
                ctx.fillStyle = 'rgba(0,0,0,0.9)';
                ctx.fillRect(120, 120, 560, 360);
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.font = 'bold 42px Arial';
                ctx.fillText('FAZ DRIFTING BFD', 400, 200);
                ctx.font = 'bold 26px Arial';
                ctx.fillStyle = '#ff4444';
                ctx.fillText('1. DRIFT KING', 400, 280);
                ctx.fillText('(Accumulate 3000 Drift Points)', 400, 310);
                ctx.fillStyle = '#fff';
                ctx.fillText('2. CHECKPOINT DASH', 400, 370);
                ctx.fillText('(Hit 6 Checkpoints in Order)', 400, 400);
                ctx.font = '20px Arial';
                ctx.fillStyle = '#ccc';
                ctx.fillText('← → ↑ ↓ : Steer / Accel / Brake', 400, 460);
                ctx.fillText('DRIFT: Counter-steer sharply at HIGH SPEED!', 400, 490);
            } else if (gameState === 'playing') {
                const m = missions[currentMission];
                // Mission HUD
                ctx.fillStyle = 'rgba(0,0,0,0.85)';
                ctx.fillRect(15, 15, 360, 85);
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'left';
                ctx.font = 'bold 22px Arial';
                ctx.fillText(m.name, 25, 40);
                ctx.font = '20px Arial';
                const progText = m.type === 'drift' ? Math.floor(m.current).toLocaleString() : m.current;
                ctx.fillText(`${progText} / ${m.target}`, 25, 65);
                // Progress bar
                ctx.fillStyle = '#555';
                ctx.fillRect(25, 72, 340, 16);
                const percent = Math.min(1, m.current / m.target);
                ctx.fillStyle = '#00ff88';
                ctx.fillRect(25, 72, 340 * percent, 16);
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                ctx.fillText(`Time: ${elapsed}s`, 25, 97);
                // Speed
                ctx.textAlign = 'right';
                ctx.fillStyle = '#fff';
                ctx.fillText(`Speed: ${Math.floor(car.velMag * 7)} km/h`, 785, 40);
            } else if (gameState === 'success') {
                const m = missions[currentMission];
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                ctx.fillStyle = 'rgba(0,0,0,0.98)';
                ctx.fillRect(0, 0, 800, 600);
                ctx.fillStyle = '#00ff44';
                ctx.textAlign = 'center';
                ctx.font = 'bold 52px Arial';
                ctx.fillText('MISSION COMPLETE!', 400, 240);
                ctx.font = 'bold 30px Arial';
                ctx.fillStyle = '#fff';
                ctx.fillText(m.name, 400, 300);
                ctx.font = 'bold 26px Arial';
                if (m.type === 'drift') {
                    ctx.fillStyle = '#ffaa00';
                    ctx.fillText(`${Math.floor(m.current).toLocaleString()} Drift Points`, 400, 360);
                } else {
                    ctx.fillStyle = '#00ff88';
                    ctx.fillText(`Completed in ${elapsed}s`, 400, 360);
                }
                ctx.fillStyle = '#fff';
                ctx.font = '22px Arial';
                ctx.fillText('R: Retry Mission', 400, 430);
                ctx.fillText('ESC or M: Main Menu', 400, 460);
            }
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        loop();
    </script>
</body>
</html>