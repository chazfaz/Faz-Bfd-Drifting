<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faz Drifting BFD - Missions</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.min.js"></script>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:Arial,sans-serif;}
canvas{display:block;}

/* Start Screen */
#loginScreen{
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:#000 url('A_digital_illustration_in_GTA_V-style_features_a_s.png') center center / cover no-repeat;
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  color:white;font-size:28px;text-shadow:0 0 15px black;z-index:20;text-align:center;
}
#loginScreen input{padding:10px;margin:5px;border-radius:10px;border:none;font-size:18px;}
#loginScreen button{padding:10px 20px;margin:5px;border-radius:10px;border:none;background:#ff4444;color:white;font-size:18px;cursor:pointer;}

/* HUD */
#hud{position:absolute;top:20px;left:20px;display:flex;flex-direction:column;gap:8px;z-index:10;}
.hud-panel{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 15px;background:rgba(0,0,0,0.6);border-radius:12px;
  box-shadow:0 0 15px rgba(0,0,0,0.7);color:white;font-size:16px;
}
.upgrade-buttons{display:flex;flex-direction:column;margin-top:5px;}
.upgrade-buttons button{
  padding:5px 10px;margin-top:3px;border-radius:8px;border:none;background:#44ff44;color:black;cursor:pointer;font-size:14px;
}
</style>
</head>
<body>

<div id="loginScreen">
  <div id="loginTitle">FAZ DRIFTING BFD</div>
  <input type="text" id="username" placeholder="Username"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="registerBtn">Register</button>
  <button id="loginBtn">Login</button>
  <div id="loginMsg" style="margin-top:10px;color:yellow;"></div>
</div>

<div id="hud">
  <div class="hud-panel">Speed: <span id="speed">0</span> km/h</div>
  <div class="hud-panel">Drift: <span id="points">0</span></div>
  <div class="hud-panel">Money: $<span id="money">0</span></div>
  <div class="hud-panel">Mission: <span id="mission">None</span></div>
  <div class="hud-panel">Mission Timer: <span id="missionTimer">0</span>s</div>
  <div class="hud-panel">Wanted: <span id="wantedStars">0</span></div>
  <div class="hud-panel">Upgrades:
    <div class="upgrade-buttons">
      <button id="buySpeed">Speed (+$50)</button>
      <button id="buyHandling">Handling (+$50)</button>
      <button id="buyDrift">Drift (+$50)</button>
    </div>
  </div>
</div>

<script>
// ===================== Account System =====================
let username="",driftPoints=0,money=0,upgrades={speed:1,handling:1,drift:1};
let mission={active:false,pos:null,reward:0,type:"none",timer:0};
function saveAccount(user){localStorage.setItem('fd_account_'+user,JSON.stringify({password:loadAccount(user).password,driftPoints,money,upgrades,mission}));}
function loadAccount(user){const data=localStorage.getItem('fd_account_'+user);return data?JSON.parse(data):null;}
function hash(str){let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0;}return h;}
document.getElementById('registerBtn').addEventListener('click',()=>{
  const user=document.getElementById('username').value.trim();
  const pass=document.getElementById('password').value;
  if(!user||!pass){document.getElementById('loginMsg').innerText="Enter username & password";return;}
  if(loadAccount(user)){document.getElementById('loginMsg').innerText="Username exists";return;}
  localStorage.setItem('fd_account_'+user,JSON.stringify({password:hash(pass),driftPoints:0,money:0,upgrades:{speed:1,handling:1,drift:1},mission:{active:false,pos:null,reward:0,type:"none",timer:0}}));
  document.getElementById('loginMsg').innerText="Registered! You can login now.";
});
document.getElementById('loginBtn').addEventListener('click',()=>{
  const user=document.getElementById('username').value.trim();
  const pass=document.getElementById('password').value;
  const acc=loadAccount(user);
  if(!acc){document.getElementById('loginMsg').innerText="Account not found";return;}
  if(acc.password!==hash(pass)){document.getElementById('loginMsg').innerText="Wrong password";return;}
  username=user; driftPoints=acc.driftPoints; money=acc.money; upgrades=acc.upgrades; mission=acc.mission;
  startGame();
});
setInterval(()=>{if(username) saveAccount(username);},5000);

// ===================== Three.js Setup =====================
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
scene.fog=new THREE.FogExp2(0x87ceeb,0.00025);
const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,5000);
camera.position.set(0,15,30);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

// Lights
scene.add(new THREE.AmbientLight(0x404040,0.6));
const dirLight=new THREE.DirectionalLight(0xffffff,1.2);
dirLight.position.set(50,100,50);
dirLight.castShadow=true;
scene.add(dirLight);

// Ground
const ground=new THREE.Mesh(new THREE.PlaneGeometry(1000,1000),new THREE.MeshStandardMaterial({color:0x222222,roughness:0.8}));
ground.rotation.x=-Math.PI/2;
ground.receiveShadow=true;
scene.add(ground);

// Buildings
const buildings=[];
for(let i=0;i<20;i++){
  const w=20+Math.random()*40,h=30+Math.random()*80,d=20+Math.random()*40;
  const b=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshStandardMaterial({color:new THREE.Color(Math.random(),Math.random(),Math.random())}));
  b.position.set((Math.random()-0.5)*400,h/2,(Math.random()-0.5)*400);
  b.castShadow=true;b.receiveShadow=true;
  scene.add(b); buildings.push(b);
}

// Player Car
const carGroup=new THREE.Group();
const body=new THREE.Mesh(new THREE.BoxGeometry(2.5,1.2,4.5),new THREE.MeshStandardMaterial({color:0xff3333}));
body.castShadow=true; carGroup.add(body);
const wheelGeo=new THREE.CylinderGeometry(0.45,0.45,0.35,12); const wheelMat=new THREE.MeshStandardMaterial({color:0x111111});
const playerWheels=[];
for(let i=0;i<4;i++){
  const wheel=new THREE.Mesh(wheelGeo,wheelMat); wheel.rotation.z=Math.PI/2; wheel.castShadow=true;
  playerWheels.push(wheel); carGroup.add(wheel);
}
playerWheels[0].position.set(-1.2,-0.55,1.6); playerWheels[1].position.set(1.2,-0.55,1.6);
playerWheels[2].position.set(-1.2,-0.55,-1.6); playerWheels[3].position.set(1.2,-0.55,-1.6);
scene.add(carGroup); carGroup.position.set(0,0.5,0); carGroup.scale.set(1.5,1.5,1.5);

// Coins
let coins=[];
function spawnCoins(num=20){
  for(let i=0;i<num;i++){
    const c=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,12),new THREE.MeshStandardMaterial({color:0xffcc00,metalness:0.6,roughness:0.2}));
    c.position.set((Math.random()-0.5)*400,0.5,(Math.random()-0.5)*400);
    scene.add(c); coins.push(c);
  }
}
spawnCoins();

// NPC Traffic
const npcs=[]; const npcColors=[0x4444ff,0xaa44ff,0x44ff44,0xffff44,0xff8844,0x44aaff,0xff44aa,0xaaff44];
function createNPC(x,z,rotY,color){
  const npcGroup = carGroup.clone();
  npcGroup.position.set(x,0.5,z); npcGroup.rotation.y = rotY; npcGroup.scale.setScalar(0.8+Math.random()*0.2);
  npcGroup.traverse(child=>{if(child.isMesh){child.castShadow=true;child.receiveShadow=true;}});
  npcGroup.userData = {velocityZ:0,targetSpeed:1+Math.random()*0.5,maxSpeed:1.5+Math.random()*0.5};
  scene.add(npcGroup); return npcGroup;
}
for(let i=0;i<40;i++){
  let x=(Math.random()-0.5)*400,z=(Math.random()-0.5)*400,rotY=Math.random()<0.5?0:Math.PI;
  const color=npcColors[Math.floor(Math.random()*npcColors.length)]; npcs.push(createNPC(x,z,rotY,color));
}

// Wanted Level
let wantedLevel=0; function increaseWanted(a){wantedLevel=Math.min(5,wantedLevel+a);}
function decreaseWanted(a){wantedLevel=Math.max(0,wantedLevel-a);}

// Player Input
const velocity=new THREE.Vector3();
let moveForward=false,moveBackward=false,moveLeft=false,moveRight=false,handbrake=false;
document.addEventListener('keydown',e=>{switch(e.code){case 'KeyW':moveForward=true;break;case 'KeyS':moveBackward=true;break;case 'KeyA':moveLeft=true;break;case 'KeyD':moveRight=true;break;case 'Space':handbrake=true;break;}});
document.addEventListener('keyup',e=>{switch(e.code){case 'KeyW':moveForward=false;break;case 'KeyS':moveBackward=false;break;case 'KeyA':moveLeft=false;break;case 'KeyD':moveRight=false;break;case 'Space':handbrake=false;break;}});

// Upgrades
document.getElementById('buySpeed').addEventListener('click',()=>{if(money>=50){upgrades.speed+=0.2;money-=50;}});
document.getElementById('buyHandling').addEventListener('click',()=>{if(money>=50){upgrades.handling+=0.2;money-=50;}});
document.getElementById('buyDrift').addEventListener('click',()=>{if(money>=50){upgrades.drift+=0.2;money-=50;}});

// Missions
let checkpoint=null;
function spawnMission(){
  if(mission.active) return;
  const type=Math.random();
  const x=(Math.random()-0.5)*300; const z=(Math.random()-0.5)*300;
  if(type<0.5){ // Checkpoint Mission
    const geo=new THREE.BoxGeometry(3,1,3); const mat=new THREE.MeshStandardMaterial({color:0x00ff00});
    checkpoint=new THREE.Mesh(geo,mat); checkpoint.position.set(x,0.5,z); scene.add(checkpoint);
    mission.active=true; mission.pos=new THREE.Vector3(x,0.5,z); mission.reward=50+Math.floor(Math.random()*50); mission.type="checkpoint"; mission.timer=0;
  } else { // Coin Collection Mission
    spawnCoins(15); mission.active=true; mission.pos=null; mission.reward=75+Math.floor(Math.random()*75); mission.type="coin"; mission.timer=120; // 2 min
  }
}
setInterval(spawnMission,30000);

// NPC AI & Police
function updateNPCs(){
  npcs.forEach(npc=>{
    const ud=npc.userData;
    ud.velocityZ+=(ud.targetSpeed-ud.velocityZ)*0.05; ud.velocityZ*=0.98;
    ud.velocityZ=Math.max(-ud.maxSpeed/2,Math.min(ud.velocityZ,ud.maxSpeed));
    npc.position.x+=Math.sin(npc.rotation.y)*ud.velocityZ;
    npc.position.z+=Math.cos(npc.rotation.y)*ud.velocityZ;
    if(Math.abs(npc.position.x)>400||Math.abs(npc.position.z)>400){npc.rotation.y+=Math.PI;ud.velocityZ*=-0.5;}
    const dist=npc.position.distanceTo(carGroup.position);
    if(dist<3.5){const pushDir=new THREE.Vector3().subVectors(carGroup.position,npc.position).normalize();
      carGroup.position.add(pushDir.multiplyScalar(0.4)); npc.position.sub(pushDir.multiplyScalar(0.4));
      velocity.z*=0.6; ud.velocityZ*=0.6; increaseWanted(1);}
  });
}
function updatePolice(){
  if(wantedLevel>0){
    npcs.forEach(npc=>{
      const ud=npc.userData;
      const dist=npc.position.distanceTo(carGroup.position);
      if(dist<50&&Math.random()<0.02){
        const dir=new THREE.Vector3().subVectors(carGroup.position,npc.position).normalize();
        npc.position.add(dir.multiplyScalar(ud.maxSpeed+wantedLevel*0.2));
      }
    });
    decreaseWanted(0.002);
  }
}

// ===================== Animate Loop =====================
function startGame(){document.getElementById('loginScreen').style.display='none';animate();}
function animate(){
  requestAnimationFrame(animate);

  // Player movement
  let accel=0;if(moveForward) accel+=0.1*upgrades.speed;if(moveBackward) accel-=0.06;
  velocity.z+=accel; velocity.z*=(handbrake?0.85:0.95);
  const maxSpeed=2.2*upgrades.speed; velocity.z=Math.max(-maxSpeed*0.7,Math.min(velocity.z,maxSpeed));
  let steer=0;if(moveLeft) steer-=1;if(moveRight) steer+=1;
  carGroup.rotation.y+=steer*0.05*upgrades.handling;
  carGroup.position.x+=Math.sin(carGroup.rotation.y)*velocity.z;
  carGroup.position.z+=Math.cos(carGroup.rotation.y)*velocity.z;
  const wheelSpeed=velocity.z*4; playerWheels.forEach(w=>{w.rotation.x+=wheelSpeed;});

  // Coins
  for(let i=coins.length-1;i>=0;i--){
    if(coins[i].position.distanceTo(carGroup.position)<2){
      money+=10; scene.remove(coins[i]); coins.splice(i,1);
      if(mission.type==="coin") mission.reward-=1; if(mission.reward<=0) {mission.active=false; mission.type="none";}
    }
  }

  // Checkpoint mission
  if(mission.active && mission.type==="checkpoint" && checkpoint && carGroup.position.distanceTo(checkpoint.position)<3){
    money+=mission.reward; scene.remove(checkpoint); checkpoint=null; mission.active=false; mission.type="none"; mission.reward=0;
  }

  // Mission timer
  if(mission.active && mission.type==="coin"){ mission.timer-=1/60; if(mission.timer<=0){mission.active=false; mission.type="none"; mission.reward=0;}}

  updateNPCs(); updatePolice();

  // HUD
  document.getElementById('speed').textContent=Math.floor(Math.abs(velocity.z)*45);
  document.getElementById('points').textContent=Math.floor(driftPoints);
  document.getElementById('money').textContent=Math.floor(money);
  document.getElementById('mission').textContent=mission.type!=="none"?mission.type.charAt(0).toUpperCase()+mission.type.slice(1):"None";
  document.getElementById('missionTimer').textContent=Math.floor(mission.timer);
  document.getElementById('wantedStars').textContent=wantedLevel;

  // Camera
  const camOffset=new THREE.Vector3(0,14,20); camOffset.applyQuaternion(carGroup.quaternion); camOffset.add(carGroup.position);
  camera.position.lerp(camOffset,0.1); camera.lookAt(carGroup.position.clone().add(new THREE.Vector3(0,2,5)));

  renderer.render(scene,camera);
}

// Resize
window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
</script>
</body>
</html>
